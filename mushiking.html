<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.3.min.js"></script>
<link rel="stylesheet" href="css/sample.css">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=M+PLUS+1p&display=swap" rel="stylesheet">
<title>じゃんけん</title>
</head>
<body>

<header>
  <h1>ムシキング Web</h1>
</header>

<main>
  <div class="mushi-king-wrapper">
    <!-- 昆虫選択ボタンの表示 -->
    <div class="select-button-wrapper">
      <button id="select-btn">虫を選ぶ</button>
    </div>
    <!-- 昆虫際選択ボタンの表示 -->
    <div class="re-select-button-wrapper">
      <a href="#" id="re_select_button" class="btn btn-malformation">虫を選び直す</a>
    </div>
    <!-- モーダル画面 -->
    <div id="modal-wrapper">
      <div class="choice-beat">
        <h2>使用する昆虫を選んでね！</h2>
        <form action="">
          <ul class="select-wrapper">
            <li class="mushi-img" id="select_beat"><img src="./img/kabutomushi_2.jpg" alt=""><span>カブトムシ</span></li>
            <li class="mushi-img" id="select_beat"><img src="./img/kuwagata.jpg" alt=""><span>クワガタ</span></li>
            <li class="mushi-img" id="select_beat"><img src="./img/herakuresu_2.jpg" alt=""><span>ヘラクレスオオカブト</span></li>
          </ul>
          <div id="submit-btn">この虫に決まり！</div>
        </form>
      </div>
    </div>
    <!-- 虫のプロフィールレイアウト -->
    <div class="user-beat-profile-wrapper">
      <div id="user-beat-profile">
        <img id="selected_beat_img" src="" alt="">
        <ul>
          <li id="gu_tech"></li>
          <li id="choki_tech"></li>
          <li id="par_tech"></li>
        </ul>
      </div>
      <!-- 勝負ボタン -->
      <div id="battle_button_wrapper">
        <button id="battle_start">勝負開始</button>
      </div>
    </div>
    <!-- 出す手のコマ -->
    <div class="junken-hand-wrapper">
      <ul id="janken-wrapper">
        <li id="gu_btn" data-id="1"><img src="https://mushiking.com/old/cards/img/iconb_wg.gif" alt=""></li>
        <li id="cho_btn" data-id="2"><img src="https://mushiking.com/old/cards/img/iconb_wc.gif" alt=""></li>
        <li id="par_btn" data-id="3"><img src="https://mushiking.com/old/cards/img/iconb_wp.gif" alt=""></li>
      </ul>
    </div>
    <!-- バトル画面 -->
    <div id="battle_wrapper">
      <div id="user_battle_wrapper">
        <h2 id="user_name">You</h2>
        <img id="user_beat_img" src="" alt="">
        <div id="user_selected_hand">
          <img id="selected_hand_img" src="" alt="">
        </div>
      </div>
      <div id="enemy_battle_wrapper">
        <h2 id="enemy_name">Enemy</h2>
        <img id="enemy_beat_img" src="" alt="">
        <div id="enemy_selected_hand">
          <img id="enemy_hand_img" src="" alt="">
        </div>
      </div>
      <!-- 体力ゲージ -->
      <div id="life_wrapper">
        <div id="user_life_wrapper">
          <div id="user_life_bar"></div>
        </div>
        <div id="enemy_life_wrapper">
          <div id="enemy_life_bar"></div>
        </div>
      </div>
    </div>
    <div class="result-modal-wrapper">
      <div id="result_wrapper">
        <div id="result"></div>
        <div id="final_select_wrapper">
          <div id="retry_button"></div>
          <div id="end_button"></div>
        </div>
      </div>
    </div>
  </div>
</main>

<footer></footer>
<script>
//じゃんけん用のSCRIPTを書いてください
// グー：1、チョキ：2、パー：3
  
  // グローバル変数定義
  let user_beat = null;
  let selected_beat = null;
  let user_beat_eng = null;
  let enemy_info = null;
  let max_user_hp = 0;
  let current_user_hp = 0;
  let max_enemy_hp = 0;
  let current_enemy_hp = 0;
  let insects_list;
  let kabutomushi;
  let herakuresu;
  let kuwagata;

  const hand_image = {
    gu: "https://mushiking.com/old/cards/img/iconb_wg.gif",
    choki: "https://mushiking.com/old/cards/img/iconb_wc.gif",
    par: "https://mushiking.com/old/cards/img/iconb_wp.gif"
  }

  // ローカルストレージへHPを格納
  function insertHP(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

  // ローカルストレージからデータを取得する関数
  function getHP(key, defaultValue) {
    const storedValue = localStorage.getItem(key);
    return storedValue !== null ? JSON.parse(storedValue) : defaultValue;
  }

  // ダメージ換算関数
  function attackDamage(damage, target) {
    let animationEnded = false;
    let hpZero = false;
    let enemy_hpPercentage = 100;
    let calculatedPercentage = 100;

    if (target === "user" || target === "") {
      current_user_hp = getHP("current_user_hp", current_user_hp);
      current_user_hp = Math.max(0, current_user_hp - damage);
      insertHP("current_user_hp", current_user_hp);
      let user_hpPercentage = Math.floor((current_user_hp / max_user_hp) * 100);
      $("#user_life_bar").css('width', user_hpPercentage + '%');
      if (current_user_hp === 0) hpZero = true;
    }

    if (target === "enemy" || target === "") {
      current_enemy_hp = getHP("current_enemy_hp", current_enemy_hp);
      console.log("敵の体力:" + current_enemy_hp);
      console.log(damage)
      current_enemy_hp = Math.max(0, current_enemy_hp - damage);
      insertHP("current_enemy_hp", current_enemy_hp);
      enemy_hpPercentage = Math.floor((current_enemy_hp / max_enemy_hp) * 100);
      $("#enemy_life_bar").css('width', enemy_hpPercentage + '%');
      if (current_enemy_hp === 0) hpZero = true;
      console.log(`攻撃後 - Enemy HP: ${current_enemy_hp}, Percentage: ${enemy_hpPercentage}%, hpZero: ${hpZero}`);
    }

    if (hpZero) {
        const lifeBar = target === "user" ? $("#user_life_bar") : $("#enemy_life_bar");
        lifeBar.one('transitionend', function() {
            animationEnded = true;
            checkGameOver();
        });

        setTimeout(function() {
            if (!animationEnded) {
                console.log("Transition didn't occur, forcing game over check");
                checkGameOver();
            }
        }, 800);
    }

    function checkGameOver() {
      if (current_enemy_hp === 0) {
          $(".result-modal-wrapper").fadeIn();
          $("#result").html("You Win!!");
          $("#retry_button").html("やり直す");
          $("#end_button").html("終わり");
      } else if (current_user_hp === 0) {
          $(".result-modal-wrapper").fadeIn();
          $("#result").html("Lose...");
          $("#retry_button").html("やり直す");
          $("#end_button").html("終わり");
      }
    } 
  }

  // ランダムで敵を指定する関数
  function getEnemyData(id) {
    for (let key in insects_list) {
      if(insects_list[key].id === id){
        return insects_list[key];
      }
    }
    return null
  }
  
  // 昆虫が選択されているかの監視関数
    function checkSelect(){
      if(user_beat == null){
        alert("昆虫を選択してください。");
        return false;
      }
      return true;
    }

  // 昆虫選択モーダル
  $("#select-btn").on("click", function(){
    $("#modal-wrapper").fadeIn();
  })

  // 昆虫確定ボタンを押下後の動き
  $("#submit-btn").on("click", function(event){
    if(!checkSelect()) {
      return;
    }
    $("#modal-wrapper").fadeOut();
    $("#user-beat-profile").show();
    $(".select-button-wrapper").hide();
    $(".re-select-button-wrapper").show();
    setTimeout(function(){
      $("#battle_button_wrapper").fadeIn(1000);
    }, 1000)
    selected_beat = user_beat;
    if(selected_beat == "カブトムシ"){
      user_beat_eng = "kabutomushi";
      max_user_hp = current_user_hp = kabutomushi.max_hp;
      $("#selected_beat_img").attr('src', kabutomushi.image)
      $("#gu_tech").html("グー：" + kabutomushi.gu)
      $("#choki_tech").html("チョキ：" + kabutomushi.choki)
      $("#par_tech").html("パー：" +kabutomushi.par)
    } else if(selected_beat == "クワガタ") {
      user_beat_eng = "kuwagata";
      console.log(user_beat_eng);
      max_user_hp = current_user_hp = kuwagata.max_hp;
      $("#selected_beat_img").attr('src', kuwagata.image)
      $("#gu_tech").html("グー：" + kuwagata.gu)
      $("#choki_tech").html("チョキ：" + kuwagata.choki)
      $("#par_tech").html("パー：" +kuwagata.par)
    } else {
      user_beat_eng = "herakuresu";
      max_user_hp = current_user_hp = herakuresu.max_hp;
      $("#selected_beat_img").attr('src', herakuresu.image)
      $("#gu_tech").html("グー：" + herakuresu.gu)
      $("#choki_tech").html("チョキ：" + herakuresu.choki)
      $("#par_tech").html("パー：" +herakuresu.par)
    }
  })

  // 昆虫再選択画面表示時の動き
  $("#re_select_button").on("click", function(){
    $("#modal-wrapper").fadeIn();
  })

  // 昆虫選択モーダルを画面外タップで非表示にする
  $(document).on('click', function(event) {
    // 表示したポップアップ以外の部分をクリックしたとき
    if ($(event.target).is('#modal-wrapper')) {
      $('#modal-wrapper').fadeOut();
    }
  });

  // 初期の画面制御
  $(document).ready(function(){
    // JSONファイルから昆虫データを取得
    $.getJSON('../assets/insects_list.json', function(data) {
      insects_list = data;
      console.log(insects_list.kabutomushi.choki); // JSONデータが格納された変数を確認
      kabutomushi = insects_list.kabutomushi;
      herakuresu = insects_list.herakuresu;
      kuwagata = insects_list.kuwagata;
    });
    $("#user-beat-profile").hide();
    $("#battle_button_wrapper").hide();
    $(".re-select-button-wrapper").hide();
    $(".result-modal-wrapper").hide();
    $("#janken-wrapper").hide();
    $("#user_name, #enemy_name").hide();
    $("#life_wrapper").hide();
    
  })

  $(".mushi-img").on('click', function(){
    $(".mushi-img").css("background-color", "");
    $(this).css("background-color", "#0066CC")
    user_beat = $(this).text();
  })

  // バトルボタン押下後の動き
  $(document).ready(function(){
    $(document).on("click", "#battle_start", function(){
      let enemy_id = Math.random()*3;
      enemy_id = Math.ceil(enemy_id);
      const enemy_info = getEnemyData(enemy_id);
      console.log(enemy_info);
      $("#selected_hand_img, #enemy_hand_img").attr('src', "")
      $("#janken-wrapper").show();
      $("#user_name, #enemy_name").show();
      $("#life_wrapper").show();
      $("#battle_wrapper").show();
      $(".junken-hand-wrapper").show(); 
      $("#user_beat_img").attr('src', insects_list[user_beat_eng].image)
      $("#enemy_beat_img").attr('src', enemy_info.image)
      max_enemy_hp = enemy_info.max_hp;
      current_enemy_hp = enemy_info.max_hp;
      insertHP("current_user_hp", max_user_hp);
      insertHP("current_enemy_hp", max_enemy_hp);
      $("#battle_button_wrapper").fadeOut();
      $(".re-select-button-wrapper").fadeOut();
    })
  })
  
  function disableButtons() {
    $("#gu_btn, #cho_btn, #par_btn").prop("disabled", true);
  }

  function enableButtons() {
    $("#gu_btn, #cho_btn, #par_btn").prop("disabled", false);
  }
  

  // じゃんけんアルゴリズム
  $("#gu_btn, #cho_btn, #par_btn").on("click", function(){
    disableButtons();
    const user_hand = $(this).data('id');  
    const r = Math.random()*3;
    const n = Math.ceil(r);
    console.log(current_user_hp);
    console.log(current_enemy_hp);

    // ユーザーが出した手に沿った画像を表示
    if(user_hand == 1){
      $("#selected_hand_img").attr('src', hand_image.gu)
    } else if(user_hand == 2){
      $("#selected_hand_img").attr('src', hand_image.choki)
    } else {
      $("#selected_hand_img").attr('src', hand_image.par)
    }

    // コンピューターが出した手に沿って画像を表示
    if(n == 1){
      $("#enemy_hand_img").attr('src', hand_image.gu)
    } else if(n == 2){
      $("#enemy_hand_img").attr('src', hand_image.choki)
    } else {
      $("#enemy_hand_img").attr('src', hand_image.par)
    }

    // 勝敗判定
    if(user_hand == n){
      attackDamage(20, "");
    }else if((user_hand == 1 && n == 2) || (user_hand == 2 && n == 3) || (user_hand == 3 && n == 1)){
      if(user_hand == 1){
        attackDamage(20*(kabutomushi.gu_power), "enemy");
      }else if(user_hand == 2){
        attackDamage(20*(kabutomushi.choki_power), "enemy");
      }else if(user_hand == 3){
        attackDamage(20*(kabutomushi.par_power), "enemy");
      }
    }
    else {
      if(n == 1){
        attackDamage(20*(herakuresu.gu_power), "user");
      } else if(n == 2){
        attackDamage(20*(herakuresu.choki_power), "user");
      } else if(n == 3){
        attackDamage(20*(herakuresu.par_power), "user");
      }
    }
    setTimeout(enableButtons, 3000);
  })

  $('#end_button').click(function() {
    $('.result-modal-wrapper').hide();
    localStorage.removeItem("current_user_hp");
    localStorage.removeItem("current_enemy_hp");
    location.reload();
  });

  $("#retry_button").click(function(){
    localStorage.removeItem("current_user_hp");
    localStorage.removeItem("current_enemy_hp");
    $(".result-modal-wrapper").fadeOut();
    $(".re-select-button-wrapper").show();
    $(".junken-hand-wrapper").hide();
    $("#battle_wrapper").hide();
    current_user_hp = max_user_hp;
    current_enemy_hp = max_enemy_hp;
    insertHP("current_user_hp", current_user_hp);
    insertHP("current_enemy_hp", current_enemy_hp);
    
    // HPバーを100%に戻す
    $("#user_life_bar, #enemy_life_bar").css('width', '100%');

    setTimeout(function(){
      $("#battle_button_wrapper").fadeIn(1000);
    }, 1000)
  })

</script>
</body>
</html>
